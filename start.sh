#!/bin/bash

LOG_FILE="server.log"

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤
# log() {
#     echo "$(date +"%Y-%m-%d %H:%M:%S") - $1" | tee -a "$LOG_FILE"
# }

log "üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞..."

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Python
if source venv/bin/activate; then
    log "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ."
else
    log "‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è!"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –Ω–∞ Node.js –≤ —Ñ–æ–Ω–µ –∏ –ª–æ–≥–∏—Ä—É–µ–º –µ–≥–æ –≤—ã–≤–æ–¥
log "üîµ –ó–∞–ø—É—Å–∫ server.js..."
node server.js >> "$LOG_FILE" 2>&1 &
NODE_PID=$!
sleep 2  # –î–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–æ—Ü–µ—Å—Å—É –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è

if ps -p $NODE_PID > /dev/null; then
    log "‚úÖ server.js –∑–∞–ø—É—â–µ–Ω (PID: $NODE_PID)."
else
    log "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ server.js!"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º Python-–±–æ—Ç–∞ –∏ –ª–æ–≥–∏—Ä—É–µ–º –µ–≥–æ –≤—ã–≤–æ–¥
log "ü§ñ –ó–∞–ø—É—Å–∫ main.py..."
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
 >> "$LOG_FILE" 2>&1 &
PYTHON_PID=$!
sleep 2  # –î–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–æ—Ü–µ—Å—Å—É –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è

if ps -p $PYTHON_PID > /dev/null; then
    log "‚úÖ main.py –∑–∞–ø—É—â–µ–Ω (PID: $PYTHON_PID)."
else
    log "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ main.py!"
    kill $NODE_PID
    exit 1
fi

# –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Python-–±–æ—Ç–∞
wait $PYTHON_PID
log "‚ùå main.py –∑–∞–≤–µ—Ä—à–∏–ª—Å—è."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä, –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
if ps -p $NODE_PID > /dev/null; then
    log "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ server.js..."
    kill $NODE_PID
    log "‚úÖ server.js –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
else
    log "‚ö†Ô∏è server.js —É–∂–µ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
fi

log "üöÄ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à—ë–Ω."
